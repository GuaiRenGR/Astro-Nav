<div class="relative max-w-2xl mx-auto mb-8">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="搜索网站... (Ctrl/Cmd + K)"
      class="w-full px-6 py-4 pl-14 rounded-2xl border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all duration-300 shadow-sm hover:shadow-md"
    />

    <!-- 搜索图标 -->
    <svg
      class="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>

    <!-- 清除按钮 -->
    <button
      id="clear-search"
      class="absolute right-5 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors hidden"
      aria-label="清除搜索"
    >
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- 搜索提示 -->
  <div class="mt-2 text-sm text-gray-500 dark:text-gray-400 text-center">
    支持网站名称、描述、标签搜索
  </div>
</div>

<script>
  import Fuse from 'fuse.js';

  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const clearButton = document.getElementById('clear-search') as HTMLButtonElement;
  const sitesGrid = document.getElementById('sites-grid');
  const noResults = document.getElementById('no-results');

  let fuse: Fuse<any>;
  let allSites: any[] = [];

  // 初始化搜索
  function initSearch() {
    const sitesData = document.getElementById('sites-data')?.textContent;
    if (sitesData) {
      allSites = JSON.parse(sitesData);

      // 配置 Fuse.js
      fuse = new Fuse(allSites, {
        keys: [
          { name: 'name', weight: 2 },
          { name: 'description', weight: 1 },
          { name: 'tags', weight: 1.5 },
          { name: 'pinyin', weight: 1.5 },
        ],
        threshold: 0.3,
        includeScore: true,
      });
    }
  }

  // 执行搜索
  function performSearch(query: string) {
    if (!sitesGrid || !noResults) return;

    const cards = Array.from(sitesGrid.querySelectorAll('.site-card'));

    if (!query.trim()) {
      // 显示所有卡片
      cards.forEach((card, index) => {
        (card as HTMLElement).style.display = 'block';
        (card as HTMLElement).style.animationDelay = `${index * 50}ms`;
      });
      noResults.classList.add('hidden');
      clearButton.classList.add('hidden');
      return;
    }

    clearButton.classList.remove('hidden');

    // 搜索
    const results = fuse.search(query);
    const resultIds = new Set(results.map(r => r.item.id));

    let visibleCount = 0;
    cards.forEach((card) => {
      const siteId = (card as HTMLElement).dataset.siteId;
      if (resultIds.has(siteId)) {
        (card as HTMLElement).style.display = 'block';
        (card as HTMLElement).style.animationDelay = `${visibleCount * 50}ms`;
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    // 显示/隐藏无结果提示
    noResults.classList.toggle('hidden', visibleCount > 0);
  }

  // 防抖
  function debounce(func: Function, wait: number) {
    let timeout: number;
    return function executedFunction(...args: any[]) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait) as unknown as number;
    };
  }

  // 事件监听
  searchInput?.addEventListener('input', debounce((e: Event) => {
    performSearch((e.target as HTMLInputElement).value);
  }, 300));

  clearButton?.addEventListener('click', () => {
    searchInput.value = '';
    performSearch('');
  });

  // 快捷键
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      searchInput?.focus();
    }

    if (e.key === 'Escape') {
      searchInput?.blur();
      searchInput.value = '';
      performSearch('');
    }
  });

  // 初始化
  initSearch();
</script>

<style>
  #search-input:focus {
    animation: searchPulse 2s ease-in-out infinite;
  }

  @keyframes searchPulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
    }
  }
</style>
